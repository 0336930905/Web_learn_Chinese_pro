<!DOCTYPE html>

<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Kids Vocab App - Login</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üîê</text></svg>">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&amp;display=swap" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="/css/landing-common.css" />
    <script src="/i18n/translations.js"></script>
    <script src="/js/api-client.js"></script>
    <script src="/js/landing-header.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#4ce64c",
                        "primary-dark": "#3db83d",
                        "background-light": "#f8fbf8",
                        "background-dark": "#112111",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1a2e1a",
                        "text-main": "#0e1b0e",
                        "text-muted": "#509550",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        /* Page-specific styles for login mascot illustration */
    </style>
</head>

<body
    class="font-display bg-background-light dark:bg-background-dark text-text-main dark:text-white antialiased transition-colors duration-200">
    <!-- Header Navigation -->
    <div id="landing-header-placeholder" style="position: fixed; top: 1rem; z-index: 50; left: 0; right: 0; margin: 0 auto; max-width: 1400px; padding: 0 1rem;"></div>
    <div class="relative flex min-h-screen w-full flex-row overflow-hidden pt-24">
        <!-- Left Side: Mascot Illustration (Visible on Desktop) -->
        <div
            class="hidden lg:flex lg:w-1/2 relative flex-col items-center justify-center p-12 bg-background-light dark:bg-background-dark">
            <div class="absolute inset-0 overflow-hidden">
                <!-- Decorative Blobs -->
                <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-primary/20 rounded-full blur-3xl">
                </div>
                <div
                    class="absolute bottom-[-10%] right-[-10%] w-[400px] h-[400px] bg-blue-300/20 rounded-full blur-3xl">
                </div>
            </div>
            <div class="relative z-10 flex flex-col items-center gap-8 text-center max-w-lg">
                <div class="relative w-full aspect-square max-w-[500px]">
                    <!-- Using a placeholder for the mascot as per instructions, but styled specifically -->
                    <div class="w-full h-full bg-center bg-contain bg-no-repeat drop-shadow-2xl transition-transform hover:scale-105 duration-500"
                        data-alt="3D cute mascot character holding a colorful book"
                        style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDb-6BVaBxOsHZYpINYY3slcNcm8o6ckGuRoBCUAAvQ3i6QGMG0F2EJEjhKQrLT1V1ApQpbllpPCq6BKsMU-F9Zi53jrWgizrlCxPRC-XcdYh3k8LTlzTd7ZDtvo8firG1gYcVwnLDLO6nqaX7wmBXoF1k8mMPBEIECisIwFWIhjSmGc889JuKz1ImgwqSpL9A7krS87wxaKLhkQIZy6py0jxa8sHaGs_RtVWQXs-zdErUE-ZoCweuiejG7xbGZEshMy3n-1a67bCA");'>
                    </div>
                </div>
                <div class="space-y-4">
                    <h2 class="text-3xl font-black tracking-tight text-[#0e1b0e] dark:text-white leading-tight">
                        <span data-i18n="login.heroTitle">Learning is an</span><br /> 
                        <span class="text-primary-dark dark:text-primary" data-i18n="login.heroSubtitle">Adventure!</span>
                    </h2>
                    <p class="text-lg font-medium text-text-muted dark:text-gray-300" data-i18n="login.heroDescription">
                        Join 10,000+ kids mastering new words every day.
                    </p>
                </div>
            </div>
        </div>
        <!-- Right Side: Login Form -->
        <div class="flex w-full lg:w-1/2 flex-col items-center justify-center p-6 sm:p-12 overflow-y-auto">
            <div
                class="w-full max-w-md space-y-8 bg-surface-light dark:bg-surface-dark p-8 rounded-xl shadow-sm lg:shadow-none">
                <!-- Mobile Header (Only visible on small screens) -->
                <div class="lg:hidden flex justify-center mb-6">
                    <div class="w-24 h-24 bg-center bg-cover bg-no-repeat rounded-full bg-primary/20"
                        data-alt="Small app logo mascot icon"
                        style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBl1gNQZxn0Bj1wCNuDPW8n5QUPEbyHzKl9AO51c-VtjeVyEwMjWqMa410KG1nx-H4LqPGdb5dM1el3zjONkWOoLq6tJ8stjkvSeFWeZCHi0Jx_9vpkyQ_J_XQjWAvvaSXBnVejSm8g4vimP1YaMfflnynucPtg1hJaR7bGwt2onlP-TTXvNTCsLYsocTprvM7-jmv_l20CDiW_EJJ4Y7FrGaf25pUh64F33OsXWS9K8QHit1shFiSfK4lYDz-zFBztH9pphzN7K9E");'>
                    </div>
                </div>
                <div class="text-center space-y-2">
                    <h1 class="text-4xl font-black text-[#0e1b0e] dark:text-white tracking-tight" data-i18n="login.title">
                        Welcome Back!
                    </h1>
                    <p class="text-text-muted dark:text-gray-400 text-lg" data-i18n="login.subtitle">
                        Let's jump back into the story.
                    </p>
                </div>
                <form class="space-y-6 mt-8" id="loginForm">
                    <!-- Email Field -->
                    <div class="space-y-2 group">
                        <label
                            class="text-base font-bold text-[#0e1b0e] dark:text-gray-200 ml-1 flex items-center gap-2"
                            for="email">
                            <span class="material-symbols-outlined text-primary" style="font-size: 20px;">email</span>
                            <span data-i18n="login.email">Email</span>
                        </label>
                        <div class="relative transition-all duration-300 transform group-focus-within:scale-[1.02]">
                            <input
                                autocomplete="username"
                                class="w-full h-14 pl-5 pr-4 rounded-full bg-background-light dark:bg-background-dark border-2 border-transparent focus:border-primary focus:ring-4 focus:ring-primary/20 text-lg text-text-main dark:text-white placeholder:text-text-muted/70 outline-none transition-all"
                                id="email" 
                                data-i18n-placeholder="login.emailPlaceholder"
                                placeholder="Enter your email" 
                                type="email"
                                required />
                        </div>
                        <p class="text-red-500 text-sm ml-2 hidden" id="emailError"></p>
                    </div>
                    <!-- Password Field -->
                    <div class="space-y-2 group">
                        <label
                            class="text-base font-bold text-[#0e1b0e] dark:text-gray-200 ml-1 flex items-center gap-2"
                            for="password">
                            <span class="material-symbols-outlined text-primary" style="font-size: 20px;">lock</span>
                            <span data-i18n="login.password">Password</span>
                        </label>
                        <div class="relative transition-all duration-300 transform group-focus-within:scale-[1.02]">
                            <input
                                autocomplete="current-password"
                                class="w-full h-14 pl-5 pr-12 rounded-full bg-background-light dark:bg-background-dark border-2 border-transparent focus:border-primary focus:ring-4 focus:ring-primary/20 text-lg text-text-main dark:text-white placeholder:text-text-muted/70 outline-none transition-all"
                                id="password" 
                                data-i18n-placeholder="login.passwordPlaceholder"
                                placeholder="Enter your secret code" 
                                type="password"
                                required />
                            <button
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted hover:text-primary transition-colors p-1"
                                type="button"
                                id="togglePassword">
                                <span class="material-symbols-outlined" style="font-size: 24px;">visibility</span>
                            </button>
                        </div>
                        <p class="text-red-500 text-sm ml-2 hidden" id="passwordError"></p>
                        <div class="flex justify-end pt-1">
                            <a class="text-sm font-semibold text-text-muted hover:text-primary transition-colors flex items-center gap-1"
                                href="#" data-i18n="login.forgotPassword">
                                Forgot Password?
                            </a>
                        </div>
                    </div>
                    <!-- Actions -->
                    <div class="space-y-4 pt-4">
                        <button
                            class="w-full h-14 rounded-full bg-primary hover:bg-[#3ed93e] text-[#0e1b0e] text-lg font-black tracking-wide shadow-lg shadow-primary/30 transform active:scale-95 transition-all flex items-center justify-center gap-2 group"
                            type="submit"
                            id="loginButton">
                            <span data-i18n="login.loginButton">Let's Go!</span>
                            <span
                                class="material-symbols-outlined group-hover:translate-x-1 transition-transform font-bold">arrow_forward</span>
                        </button>
                        <div class="relative flex py-2 items-center">
                            <div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
                            <span class="flex-shrink-0 mx-4 text-gray-400 text-sm font-medium" data-i18n="login.forParents">For Parents</span>
                            <div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
                        </div>
                        <button
                            id="googleLoginBtn"
                            class="w-full h-14 rounded-full bg-white dark:bg-gray-800 border-2 border-gray-100 dark:border-gray-700 hover:border-primary/50 hover:bg-gray-50 dark:hover:bg-gray-700 text-[#0e1b0e] dark:text-white text-base font-bold shadow-sm transform active:scale-95 transition-all flex items-center justify-center gap-3"
                            type="button">
                            <!-- Google Logo placeholder using provided SVG structure -->
                            <div class="text-[#0e1b0e] dark:text-white" data-icon="GoogleLogo">
                                <svg fill="currentColor" height="20px" viewbox="0 0 256 256" width="20px"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M224,128a96,96,0,1,1-21.95-61.09,8,8,0,1,1-12.33,10.18A80,80,0,1,0,207.6,136H128a8,8,0,0,1,0-16h88A8,8,0,0,1,224,128Z">
                                    </path>
                                </svg>
                            </div>
                            <span data-i18n="login.parentLogin">Parent / Google Login</span>
                        </button>
                    </div>
                </form>
                <div class="mt-8 text-center">
                    <p class="text-sm text-text-muted dark:text-gray-500">
                        <span data-i18n="login.helpText">Need help logging in?</span>
                        <a class="font-bold text-primary hover:underline" href="#" data-i18n="login.helpLink">Ask a grown-up!</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check for error/success messages from URL parameters (e.g., from OAuth callback)
            const urlParams = new URLSearchParams(window.location.search);
            const errorParam = urlParams.get('error');
            const successParam = urlParams.get('success');
            
            if (errorParam) {
                // Show error message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-50 max-w-md w-full mx-4';
                alertDiv.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined">error</span>
                            <span class="text-sm">${decodeURIComponent(errorParam)}</span>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-red-700 hover:text-red-900">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                `;
                document.body.appendChild(alertDiv);
                
                // Auto-remove after 5 seconds
                setTimeout(() => alertDiv.remove(), 5000);
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            if (successParam) {
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-50 max-w-md w-full mx-4';
                alertDiv.innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg flex items-center gap-2">
                        <span class="material-symbols-outlined">check_circle</span>
                        <span class="text-sm">${decodeURIComponent(successParam)}</span>
                    </div>
                `;
                document.body.appendChild(alertDiv);
                
                // Auto-remove after 3 seconds
                setTimeout(() => alertDiv.remove(), 3000);
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            // Initialize i18n
            i18n.init();

            // Password visibility toggle
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');
            
            togglePassword.addEventListener('click', () => {
                const type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;
                const icon = togglePassword.querySelector('.material-symbols-outlined');
                icon.textContent = type === 'password' ? 'visibility' : 'visibility_off';
            });

            // Handle login form submission
            const loginForm = document.getElementById('loginForm');
            const loginButton = document.getElementById('loginButton');
            const emailError = document.getElementById('emailError');
            const passwordError = document.getElementById('passwordError');

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Clear previous errors
                emailError.classList.add('hidden');
                passwordError.classList.add('hidden');

                // Get form values
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;

                // Validate email
                if (!email) {
                    emailError.textContent = i18n.t('errors.emailRequired');
                    emailError.classList.remove('hidden');
                    return;
                }

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    emailError.textContent = i18n.t('errors.emailInvalid');
                    emailError.classList.remove('hidden');
                    return;
                }

                // Validate password
                if (!password) {
                    passwordError.textContent = i18n.t('errors.passwordRequired');
                    passwordError.classList.remove('hidden');
                    return;
                }

                // Disable button and show loading
                const originalText = loginButton.innerHTML;
                loginButton.disabled = true;
                loginButton.innerHTML = `
                    <svg class="animate-spin h-5 w-5 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>${i18n.t('common.loading')}</span>
                `;

                try {
                    // Call login API
                    const response = await authAPI.login(email, password);
                    console.log('===== LOGIN DEBUG START =====');
                    console.log('Full response:', JSON.stringify(response, null, 2));
                    console.log('Response.data:', response.data);
                    console.log('Response.success:', response.success);
                    console.log('Response.message:', response.message);

                    // Get user from response with proper fallback
                    const user = response.data?.user || response.user || null;
                    const token = response.data?.token || response.token || null;
                    
                    console.log('Extracted user:', user);
                    console.log('User role:', user?.role);
                    console.log('Extracted token:', token ? token.substring(0, 20) + '...' : 'MISSING');

                    // Validate we have both token and user
                    if (!token) {
                        console.error('‚ùå CRITICAL: No token found in response!');
                        alert('L·ªói ƒëƒÉng nh·∫≠p: Kh√¥ng nh·∫≠n ƒë∆∞·ª£c token x√°c th·ª±c');
                        loginButton.disabled = false;
                        loginButton.innerHTML = originalText;
                        return;
                    }
                    
                    if (!user || !user.role) {
                        console.error('‚ùå CRITICAL: No user or role found in response!');
                        alert('L·ªói ƒëƒÉng nh·∫≠p: Kh√¥ng nh·∫≠n ƒë∆∞·ª£c th√¥ng tin ng∆∞·ªùi d√πng');
                        loginButton.disabled = false;
                        loginButton.innerHTML = originalText;
                        return;
                    }

                    // CRITICAL: Explicitly save to localStorage for mobile compatibility
                    try {
                        const userJson = JSON.stringify(user);
                        console.log('User JSON length:', userJson.length);
                        
                        localStorage.setItem('authToken', token);
                        localStorage.setItem('user', userJson);
                        
                        // Clean up old keys
                        localStorage.removeItem('token');
                        localStorage.removeItem('jwtToken');
                        
                        // Verify storage
                        const storedToken = localStorage.getItem('authToken');
                        const storedUser = localStorage.getItem('user');
                        console.log('Storage verification:');
                        console.log('- Token stored:', storedToken ? storedToken.substring(0, 20) + '...' : 'FAILED');
                        console.log('- User stored:', storedUser ? 'success (' + storedUser.length + ' chars)' : 'FAILED');
                        
                        if (!storedToken || !storedUser) {
                            throw new Error('LocalStorage write verification failed');
                        }
                        
                    } catch (storageError) {
                        console.error('‚ùå localStorage error:', storageError);
                        alert('L·ªói l∆∞u th√¥ng tin ƒëƒÉng nh·∫≠p: ' + storageError.message + '\n\nVui l√≤ng th·ª≠ l·∫°i ho·∫∑c s·ª≠ d·ª•ng tr√¨nh duy·ªát kh√°c.');
                        loginButton.disabled = false;
                        loginButton.innerHTML = originalText;
                        return;
                    }

                    // Show success message
                    showNotification(i18n.t('success.loginSuccess'), 'success');

                    // Redirect based on user role
                    // Use longer delay for mobile to ensure localStorage is written
                    const isMobile = /Mobile|Android|iPhone|iPad|Zalo/i.test(navigator.userAgent);
                    const redirectDelay = isMobile ? 2000 : 1000; // Even longer for mobile
                    
                    console.log('Device type:', isMobile ? 'MOBILE' : 'DESKTOP');
                    console.log('Redirect delay:', redirectDelay + 'ms');
                    console.log('===== LOGIN DEBUG END =====');
                    
                    setTimeout(() => {
                        const role = user?.role || 'student';
                        console.log('===== REDIRECT DEBUG START =====');
                        console.log('Redirecting user with role:', role);
                        console.log('Current URL:', window.location.href);
                        console.log('Final localStorage check:');
                        console.log('- Token:', localStorage.getItem('authToken') ? 'EXISTS' : 'MISSING');
                        console.log('- User:', localStorage.getItem('user') ? 'EXISTS' : 'MISSING');
                        
                        let redirectUrl;
                        if (role === 'admin') {
                            redirectUrl = '/admin/home_ad.html';
                            console.log('Admin redirect to:', redirectUrl);
                        } else {
                            redirectUrl = '/user/home.html';
                            console.log('User redirect to:', redirectUrl);
                        }
                        
                        // MOBILE ONLY: Add token to URL as absolute fallback
                        // Do NOT include full user data (too large), just token
                        if (isMobile) {
                            const params = new URLSearchParams({
                                token: token,
                                role: role, // Only pass role, not full user object
                                auth: 'success'
                            });
                            redirectUrl = `${redirectUrl}?${params.toString()}`;
                            console.log('üì± Mobile: Added auth params to URL (token + role only)');
                        }
                        
                        console.log('Final redirect URL:', redirectUrl);
                        console.log('===== REDIRECT DEBUG END =====');
                        window.location.href = redirectUrl;
                    }, redirectDelay);

                } catch (error) {
                    console.error('‚ùå Login error:', error);
                    // Show error message
                    if (error instanceof ApiError) {
                        showNotification(error.message, 'error');
                    } else {
                        showNotification(i18n.t('errors.networkError'), 'error');
                    }

                    // Re-enable button
                    loginButton.disabled = false;
                    loginButton.innerHTML = originalText;
                }
            });

            // Show notification
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-20 right-4 z-50 px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 ${
                    type === 'success' ? 'bg-green-500' : 
                    type === 'error' ? 'bg-red-500' : 
                    'bg-blue-500'
                } text-white font-bold`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        });
        // Google Login button
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        if (googleLoginBtn) {
            googleLoginBtn.addEventListener('click', () => {
                window.location.href = '/api/auth/google';
            });
        }
    </script>
</body>

</html>