<!DOCTYPE html>

<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Reverse Quiz Game</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üéÆ</text></svg>">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="../css/games-common.css" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0d7ff2",
                        "background-light": "#f5f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }

        .dark .glass-effect {
            background: rgba(34, 26, 16, 0.7);
        }

        .pattern-bg {
            background-image: radial-gradient(#f49d25 1px, transparent 1px);
            background-size: 24px 24px;
            opacity: 0.1;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display min-h-screen flex flex-col overflow-hidden text-text-main dark:text-white transition-colors duration-200">
    <!-- Decorative Background Pattern -->
    <div class="fixed inset-0 pattern-bg pointer-events-none z-0"></div>
    <!-- Common Game Header -->
    <div id="game-header-container"></div>
    <script>
    // Insert common header
    fetch('games-header.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('game-header-container').innerHTML = html;
        // Execute scripts in the loaded HTML
        const scripts = document.getElementById('game-header-container').querySelectorAll('script');
        scripts.forEach(script => {
            const newScript = document.createElement('script');
            if (script.src) {
                newScript.src = script.src;
            } else {
                newScript.textContent = script.textContent;
            }
            document.body.appendChild(newScript);
        });
      })
      .catch(err => console.error('Failed to load game header:', err));
    </script>
        <!-- Main Game Content -->
        <main class="flex-1 flex flex-col items-center justify-center p-3 sm:p-4 md:p-6 lg:p-8 w-full max-w-6xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6 md:gap-8 w-full h-full lg:h-auto items-center">
                <!-- Left Column: The Stage (Image & Prompt) -->
                <div class="lg:col-span-7 flex flex-col w-full h-full justify-center">
                    <!-- Question Prompt -->
                    <h1
                        class="text-xl sm:text-2xl md:text-3xl lg:text-4xl xl:text-5xl font-bold text-center lg:text-left mb-4 sm:mb-6 md:mb-8 text-gray-800 dark:text-gray-100 drop-shadow-sm leading-tight">
                        Nh√¨n ·∫£nh v√† ƒëo√°n nghƒ©a.<br />
                        <span class="text-primary">ƒë√¢y l√† g√¨?</span>
                    </h1>
                    <!-- Image Card -->
                    <div
                        class="relative w-full aspect-[4/3] rounded-xl overflow-hidden shadow-2xl bg-surface-light dark:bg-surface-dark border-2 sm:border-4 border-white dark:border-surface-dark ring-1 ring-black/5 group">
                        <!-- Countdown Timer Overlay (Top Right) -->
                        <div class="absolute top-3 right-3 sm:top-4 sm:right-4 md:top-6 md:right-6 z-20">
                            <div
                                class="relative flex items-center justify-center size-16 sm:size-18 md:size-20 rounded-full bg-white dark:bg-surface-dark shadow-lg">
                                <svg class="transform -rotate-90 size-16 sm:size-18 md:size-20" viewbox="0 0 100 100">
                                    <circle class="dark:stroke-gray-700" cx="50" cy="50" fill="none" r="45"
                                        stroke="#e5e7eb" stroke-width="8"></circle>
                                    <circle class="text-primary transition-all duration-1000 ease-linear" cx="50"
                                        cy="50" fill="none" r="45" stroke="currentColor" stroke-dasharray="283"
                                        stroke-dashoffset="70" stroke-linecap="round" stroke-width="8"></circle>
                                </svg>
                                <div class="absolute flex flex-col items-center">
                                    <span class="text-lg sm:text-xl font-bold text-gray-800 dark:text-white leading-none">15</span>
                                    <span
                                        class="text-[9px] sm:text-[10px] uppercase font-bold text-text-muted dark:text-gray-400 mt-0.5">Sec</span>
                                </div>
                            </div>
                        </div>
                        <!-- Main Image -->
                        <div class="w-full h-full bg-cover bg-center transition-transform duration-700 group-hover:scale-105"
                            data-alt="A close up of a happy child smiling brightly outdoors"
                            style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuDjKg3iIv3jIveELoNW93gCcsPEfVVC0ad0jjJjIsp1vEhkO8bwJOx6r97GOinghkV45sT59VJZ5IlgFXGbpAV882qoY0MdfwUv0FeCyKhqE1l7P7Xcc5MwKjxR0FsWSFNhSrQx7hrvq-McznapWp38kFKIo5EMmjgpPJ_WZWPX2BVctNkCs5-MvAAarCz9vTqug1cdj5KgALtu9ZdB6O7eRI3wS5zE3NjbK1irutsD_tRVfDDawWbLwj8YbJjUddWE5z10U353kaw');">
                        </div>
                        <!-- Label Overlay (Optional Hint) -->
                        <div class="absolute bottom-3 left-3 sm:bottom-4 sm:left-4 md:bottom-6 md:left-6 z-20">
                            <div class="px-3 py-1.5 sm:px-4 sm:py-2 bg-white/90 dark:bg-black/60 backdrop-blur-sm rounded-lg shadow-sm">
                                <p class="text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300 flex items-center gap-1.5 sm:gap-2">
                                    <span class="material-symbols-outlined text-primary text-base sm:text-lg">lightbulb</span>
                                    Hint: It shows happiness
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Right Column: Answer Grid -->
                <div class="lg:col-span-5 w-full flex flex-col justify-center gap-3 sm:gap-4 lg:pl-8">
                    <div class="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4 w-full">
                        <!-- Option 1 -->
                        <button
                            class="group relative flex flex-col items-center justify-center p-3 sm:p-4 md:p-6 lg:p-8 h-24 sm:h-28 md:h-32 lg:h-40 rounded-xl bg-white dark:bg-surface-dark border-b-4 border-gray-200 dark:border-gray-700 hover:border-primary active:border-primary active:translate-y-1 active:scale-95 transition-all duration-200 shadow-sm hover:shadow-xl hover:shadow-primary/10">
                            <div
                                class="size-8 sm:size-9 md:size-10 mb-1.5 sm:mb-2 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-500 dark:text-blue-300 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <span class="material-symbols-outlined text-lg sm:text-xl md:text-2xl">sentiment_dissatisfied</span>
                            </div>
                            <span
                                class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-700 dark:text-gray-200 group-hover:text-primary transition-colors">Cry</span>
                            <div
                                class="absolute inset-0 border-2 border-transparent group-hover:border-primary rounded-xl pointer-events-none transition-colors">
                            </div>
                        </button>
                        <!-- Option 2 (Correct) -->
                        <button
                            class="group relative flex flex-col items-center justify-center p-3 sm:p-4 md:p-6 lg:p-8 h-24 sm:h-28 md:h-32 lg:h-40 rounded-xl bg-white dark:bg-surface-dark border-b-4 border-gray-200 dark:border-gray-700 hover:border-primary active:border-primary active:translate-y-1 active:scale-95 transition-all duration-200 shadow-sm hover:shadow-xl hover:shadow-primary/10">
                            <div
                                class="size-8 sm:size-9 md:size-10 mb-1.5 sm:mb-2 rounded-full bg-orange-50 dark:bg-orange-900/30 text-primary flex items-center justify-center group-hover:scale-110 transition-transform">
                                <span class="material-symbols-outlined text-lg sm:text-xl md:text-2xl">sentiment_very_satisfied</span>
                            </div>
                            <span
                                class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-700 dark:text-gray-200 group-hover:text-primary transition-colors">Smile</span>
                            <div
                                class="absolute inset-0 border-2 border-transparent group-hover:border-primary rounded-xl pointer-events-none transition-colors">
                            </div>
                        </button>
                        <!-- Option 3 -->
                        <button
                            class="group relative flex flex-col items-center justify-center p-3 sm:p-4 md:p-6 lg:p-8 h-24 sm:h-28 md:h-32 lg:h-40 rounded-xl bg-white dark:bg-surface-dark border-b-4 border-gray-200 dark:border-gray-700 hover:border-primary active:border-primary active:translate-y-1 active:scale-95 transition-all duration-200 shadow-sm hover:shadow-xl hover:shadow-primary/10">
                            <div
                                class="size-8 sm:size-9 md:size-10 mb-1.5 sm:mb-2 rounded-full bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <span class="material-symbols-outlined text-lg sm:text-xl md:text-2xl">directions_run</span>
                            </div>
                            <span
                                class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-700 dark:text-gray-200 group-hover:text-primary transition-colors">Run</span>
                            <div
                                class="absolute inset-0 border-2 border-transparent group-hover:border-primary rounded-xl pointer-events-none transition-colors">
                            </div>
                        </button>
                        <!-- Option 4 -->
                        <button
                            class="group relative flex flex-col items-center justify-center p-3 sm:p-4 md:p-6 lg:p-8 h-24 sm:h-28 md:h-32 lg:h-40 rounded-xl bg-white dark:bg-surface-dark border-b-4 border-gray-200 dark:border-gray-700 hover:border-primary active:border-primary active:translate-y-1 active:scale-95 transition-all duration-200 shadow-sm hover:shadow-xl hover:shadow-primary/10">
                            <div
                                class="size-8 sm:size-9 md:size-10 mb-1.5 sm:mb-2 rounded-full bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <span class="material-symbols-outlined text-lg sm:text-xl md:text-2xl">chair_alt</span>
                            </div>
                            <span
                                class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-700 dark:text-gray-200 group-hover:text-primary transition-colors">Sit</span>
                            <div
                                class="absolute inset-0 border-2 border-transparent group-hover:border-primary rounded-xl pointer-events-none transition-colors">
                            </div>
                        </button>
                    </div>
                    <div class="mt-3 sm:mt-4 md:mt-6 flex justify-center lg:justify-start">
                        <button
                            class="flex items-center gap-1.5 sm:gap-2 px-4 py-2 sm:px-6 sm:py-3 rounded-full bg-gray-100 dark:bg-surface-dark text-text-muted dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 active:scale-95 transition-all text-xs sm:text-sm font-bold">
                            <span class="material-symbols-outlined text-base sm:text-[20px]">volume_up</span>
                            Listen to question
                        </button>
                    </div>
                </div>
            </div>
        </main>
        <!-- Mobile Bottom Progress (Visible only on small screens) -->
        <div
            class="md:hidden w-full px-4 py-3 sm:px-6 sm:py-4 bg-white dark:bg-surface-dark border-t border-gray-100 dark:border-gray-800">
            <div class="flex justify-between w-full mb-2 text-xs font-bold text-text-muted dark:text-gray-400">
                <span>Question 3/10</span>
                <span>30%</span>
            </div>
            <div class="w-full h-2 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                <div class="h-full bg-primary rounded-full" style="width: 30%;"></div>
            </div>
        </div>
    </div>

<script>
// ========== Helper: Get categoryId from URL ==========
function getCategoryIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('categoryId');
}

// ========== State ==========
let questions = [];
let currentIndex = 0;
let score = 0;
let timer = null;
let timeLeft = 15;
let gameStartTime = Date.now();

// ========== Load Questions ==========
async function loadQuestions() {
    const categoryId = getCategoryIdFromUrl();
    if (!categoryId) {
        alert('Kh√¥ng t√¨m th·∫•y categoryId!');
        window.location.href = '../user/games_home.html';
        return;
    }
    
    gameStartTime = Date.now(); // Reset timer
    
    try {
        const res = await fetch(`/api/games/reverse-quiz?categoryId=${categoryId}&count=10`);
        const data = await res.json();
        if (!data.success) {
            alert('Kh√¥ng th·ªÉ t·∫£i c√¢u h·ªèi: ' + (data.error?.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
            window.location.href = '../user/games_home.html';
            return;
        }
        questions = data.data;
        currentIndex = 0;
        score = 0;
        
        // Initialize header with unified function
        if (window.updateGameHeaderProgress) {
            window.updateGameHeaderProgress({
                current: 1,
                total: questions.length,
                score: 0,
                label: 'Question',
                animateScore: false
            });
        }
        
        renderQuestion();
    } catch (err) {
        alert('L·ªói khi g·ªçi API: ' + err.message);
        window.location.href = '../user/games_home.html';
    }
}

// ========== Render Question ==========
function renderQuestion() {
    const q = questions[currentIndex];
    if (!q) {
        renderResult();
        return;
    }

    // Update progress
    updateProgress();

    // Reset timer
    resetTimer();

    // Update image
    const imageDiv = document.querySelector('.bg-cover.bg-center');
    imageDiv.style.backgroundImage = `url('${q.imageUrl}')`;
    imageDiv.setAttribute('data-alt', q.meaning);

    // Update hint
    const hintDiv = document.querySelector('.absolute.bottom-3 p, .absolute.bottom-4 p, .absolute.bottom-6 p');
    if (hintDiv) {
        hintDiv.innerHTML = `<span class="material-symbols-outlined text-primary text-base sm:text-lg">lightbulb</span>
            Hint: ${q.pinyin}`;
    }

    // Render options
    const optionsContainer = document.querySelector('.grid.grid-cols-2');
    if (!optionsContainer) {
        console.error('Options container not found');
        return;
    }
    optionsContainer.innerHTML = '';
    
    q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'group relative flex flex-col items-center justify-center p-3 sm:p-4 md:p-6 lg:p-8 h-24 sm:h-28 md:h-32 lg:h-40 rounded-xl bg-white dark:bg-surface-dark border-b-4 border-gray-200 dark:border-gray-700 hover:border-primary active:border-primary active:translate-y-1 active:scale-95 transition-all duration-200 shadow-sm hover:shadow-xl hover:shadow-primary/10';
        btn.onclick = () => selectAnswer(idx);
        
        // Icon placeholder
        const iconDiv = document.createElement('div');
        iconDiv.className = 'size-8 sm:size-9 md:size-10 mb-1.5 sm:mb-2 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-500 dark:text-blue-300 flex items-center justify-center group-hover:scale-110 transition-transform';
        iconDiv.innerHTML = '<span class="material-symbols-outlined text-lg sm:text-xl md:text-2xl">translate</span>';
        
        // Meaning text (English/Vietnamese)
        const meaningSpan = document.createElement('span');
        meaningSpan.className = 'text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-700 dark:text-gray-200 group-hover:text-primary transition-colors text-center';
        meaningSpan.textContent = opt.meaning;
        
        // Pinyin text (smaller)
        const pinyinSpan = document.createElement('span');
       
        
        btn.appendChild(iconDiv);
        btn.appendChild(meaningSpan);
        btn.appendChild(pinyinSpan);
        
        optionsContainer.appendChild(btn);
    });

    // Update listen button
    const listenBtn = document.querySelector('button[class*="mt-"]');
    if (listenBtn) {
        listenBtn.onclick = () => speakQuestion();
    }
}

// ========== Timer Functions ==========
function resetTimer() {
    if (timer) clearInterval(timer);
    timeLeft = 15;
    updateTimerDisplay();
    
    timer = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
            clearInterval(timer);
            // Auto move to next question when time's up
            setTimeout(() => {
                currentIndex++;
                renderQuestion();
            }, 500);
        }
    }, 1000);
}

function updateTimerDisplay() {
    const timerText = document.querySelector('.absolute.flex.flex-col.items-center span:first-of-type');
    if (timerText) timerText.textContent = timeLeft;
    
    // Update circular progress
    const circle = document.querySelector('.text-primary.transition-all');
    if (circle) {
        const progress = (timeLeft / 15) * 283;
        circle.setAttribute('stroke-dashoffset', 283 - progress);
    }
}

// ========== Select Answer ==========
function selectAnswer(idx) {
    if (timer) clearInterval(timer);
    
    const q = questions[currentIndex];
    const isCorrect = q.options[idx].isCorrect;
    const optionsContainer = document.querySelector('.grid.grid-cols-2');
    if (!optionsContainer) return;
    const buttons = Array.from(optionsContainer.children);
    
    // Highlight correct and selected answers
    buttons.forEach((btn, i) => {
        btn.disabled = true;
        btn.classList.remove('hover:border-primary');
        
        if (q.options[i].isCorrect) {
            btn.classList.remove('border-gray-200');
            btn.classList.add('border-green-500', 'bg-green-50', 'dark:bg-green-900/30');
        } else if (i === idx) {
            btn.classList.remove('border-gray-200');
            btn.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/30');
        }
    });
    
    // Update score
    if (isCorrect) {
        score++;
        // Update score display immediately with animation
        if (window.animateScoreUpdate) {
            window.animateScoreUpdate(score);
        }
    }
    
    // Move to next question after delay
    setTimeout(() => {
        currentIndex++;
        renderQuestion();
    }, 1500);
}

// ========== Speak Question ==========
function speakQuestion() {
    const q = questions[currentIndex];
    if (window.speakText) {
        window.speakText(q.traditional || q.simplified, 0.8);
    }
}

// ========== Update Progress ==========
function updateProgress() {
    // Use unified progress update function
    if (window.updateGameHeaderProgress) {
        window.updateGameHeaderProgress({
            current: currentIndex + 1,
            total: questions.length,
            score: score,
            label: 'Question',
            animateScore: false
        });
    }
    
    // Update mobile progress bar (bottom of screen on mobile)
    const mobileProgressContainer = document.querySelector('.md\\:hidden');
    if (mobileProgressContainer) {
        const mobileQuestionText = mobileProgressContainer.querySelector('.flex.justify-between span:first-child');
        const mobilePercentText = mobileProgressContainer.querySelector('.flex.justify-between span:last-child');
        const mobileBar = mobileProgressContainer.querySelector('.h-full.bg-primary');
        
        const percent = Math.round(((currentIndex + 1) / questions.length) * 100);
        
        if (mobileQuestionText) {
            mobileQuestionText.textContent = `Question ${currentIndex + 1}/${questions.length}`;
        }
        if (mobilePercentText) {
            mobilePercentText.textContent = `${percent}%`;
        }
        if (mobileBar) {
            mobileBar.style.width = `${percent}%`;
            mobileBar.style.transition = 'width 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
        }
    }
}

// ========== Render Result ==========
function renderResult() {
    if (timer) clearInterval(timer);
    
    const percentage = Math.round((score / questions.length) * 100);
    const totalPoints = score * 10;
    const wrongAnswers = questions.length - score;
    const duration = Math.floor((Date.now() - gameStartTime) / 1000);
    const minutes = Math.floor(duration / 60);
    const seconds = duration % 60;
    
    // Determine performance level
    let performanceEmoji = 'üéâ';
    let performanceText = 'Xu·∫•t s·∫Øc!';
    let performanceColor = 'from-green-500 to-emerald-500';
    
    if (percentage >= 90) {
        performanceEmoji = 'üèÜ';
        performanceText = 'Ho√†n h·∫£o!';
        performanceColor = 'from-yellow-400 to-amber-500';
    } else if (percentage >= 70) {
        performanceEmoji = 'üéâ';
        performanceText = 'R·∫•t t·ªët!';
        performanceColor = 'from-green-500 to-emerald-500';
    } else if (percentage >= 50) {
        performanceEmoji = 'üëç';
        performanceText = 'T·ªët!';
        performanceColor = 'from-blue-500 to-cyan-500';
    } else {
        performanceEmoji = 'üí™';
        performanceText = 'C·ªë g·∫Øng l√™n!';
        performanceColor = 'from-orange-500 to-red-500';
    }
    
    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 px-4';
    overlay.innerHTML = `
        <div id="confetti-container" class="fixed inset-0 pointer-events-none z-50"></div>
        <div class="bg-gradient-to-br from-white via-blue-50 to-purple-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 rounded-2xl md:rounded-3xl shadow-2xl p-5 sm:p-8 max-w-lg w-full border-4 border-gradient-to-r from-cyan-200 via-blue-200 to-purple-200 dark:border-gray-700 transform result-card">
            <div class="text-center">
                <!-- Emoji with animation -->
                <div class="text-6xl sm:text-8xl mb-4 emoji-animation inline-block">${performanceEmoji}</div>
                
                <!-- Title -->
                <h2 class="text-2xl sm:text-4xl font-black bg-gradient-to-r ${performanceColor} bg-clip-text text-transparent mb-2">${performanceText}</h2>
                <p class="text-base sm:text-xl text-gray-600 dark:text-gray-300 mb-4 sm:mb-6">Ho√†n th√†nh Quiz!</p>
                
                <!-- Time Badge -->
                <div class="inline-flex items-center gap-2 bg-gradient-to-r from-indigo-100 to-purple-100 dark:from-indigo-900/30 dark:to-purple-900/30 px-4 py-2 rounded-full mb-4">
                    <span class="material-symbols-outlined text-indigo-600 dark:text-indigo-400 text-lg">schedule</span>
                    <span class="text-sm font-bold text-indigo-700 dark:text-indigo-300">${minutes}:${seconds.toString().padStart(2, '0')}</span>
                </div>
                
                <!-- Stats Grid -->
                <div class="bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm rounded-2xl p-4 sm:p-6 shadow-lg mb-4 sm:mb-6">
                    <div class="grid grid-cols-2 gap-2 sm:gap-4">
                        <div class="stat-card text-center p-3 sm:p-4 bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 rounded-xl transform hover:scale-105 transition-transform duration-200">
                            <div class="text-2xl sm:text-3xl font-black text-green-600 dark:text-green-400" data-value="${score}/${questions.length}">0/${questions.length}</div>
                            <div class="text-xs sm:text-sm text-green-700 dark:text-green-300 font-semibold">ƒê√∫ng</div>
                        </div>
                        <div class="stat-card text-center p-3 sm:p-4 bg-gradient-to-br from-blue-100 to-cyan-100 dark:from-blue-900/30 dark:to-cyan-900/30 rounded-xl transform hover:scale-105 transition-transform duration-200">
                            <div class="text-2xl sm:text-3xl font-black text-blue-600 dark:text-blue-400" data-value="${percentage}">0%</div>
                            <div class="text-xs sm:text-sm text-blue-700 dark:text-blue-300 font-semibold">Ch√≠nh x√°c</div>
                        </div>
                        <div class="stat-card text-center p-3 sm:p-4 bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 rounded-xl transform hover:scale-105 transition-transform duration-200">
                            <div class="text-2xl sm:text-3xl font-black text-purple-600 dark:text-purple-400" data-value="${totalPoints}">0</div>
                            <div class="text-xs sm:text-sm text-purple-700 dark:text-purple-300 font-semibold">ƒêi·ªÉm</div>
                        </div>
                        <div class="stat-card text-center p-3 sm:p-4 bg-gradient-to-br from-amber-100 to-orange-100 dark:from-amber-900/30 dark:to-orange-900/30 rounded-xl transform hover:scale-105 transition-transform duration-200">
                            <div class="text-2xl sm:text-3xl font-black text-amber-600 dark:text-amber-400" data-value="${wrongAnswers}">0</div>
                            <div class="text-xs sm:text-sm text-amber-700 dark:text-amber-300 font-semibold">C√¢u sai</div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <button onclick="location.reload()" class="group flex-1 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white px-6 py-3 rounded-full font-bold transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-105 active:scale-95 flex items-center justify-center gap-2">
                        <span class="transform group-hover:rotate-180 transition-transform duration-500">üîÑ</span>
                        <span>Ch∆°i l·∫°i</span>
                    </button>
                    <button onclick="window.location.href='../user/games_home.html'" class="group flex-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white px-6 py-3 rounded-full font-bold transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-105 active:scale-95 flex items-center justify-center gap-2">
                        <span class="transform group-hover:scale-110 transition-transform duration-200">üè†</span>
                        <span>V·ªÅ trang ch·ªß</span>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Add enhanced animation styles
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIn {
            from { transform: scale(0.8) translateY(20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        @keyframes statPop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes emojiFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(-5deg); }
            75% { transform: translateY(-5px) rotate(5deg); }
        }
        @keyframes confettifall {
            to { transform: translateY(100vh) rotate(360deg); }
        }
        .result-card { animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .stat-card { animation: statPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .stat-card:nth-child(1) { animation-delay: 0.1s; opacity: 0; animation-fill-mode: forwards; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; opacity: 0; animation-fill-mode: forwards; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; opacity: 0; animation-fill-mode: forwards; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; opacity: 0; animation-fill-mode: forwards; }
        .emoji-animation { animation: emojiFloat 2s ease-in-out infinite; }
        .confetti { position: absolute; width: 10px; height: 10px; animation: confettifall 3s linear forwards; }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(overlay);
    
    // Animate stats with count-up effect
    setTimeout(() => {
        const statCards = overlay.querySelectorAll('.stat-card > div[data-value]');
        statCards.forEach((stat, index) => {
            const targetValue = stat.getAttribute('data-value');
            animateValue(stat, targetValue, 1000 + (index * 100));
        });
    }, 500);
    
    // Create confetti for high scores
    if (percentage >= 70) {
        setTimeout(() => createConfetti(), 800);
    }
}

// ========== Animate Value Count-up ==========
function animateValue(element, target, duration) {
    const isPercentage = target.includes('%');
    const isFraction = target.includes('/');
    
    if (isFraction) {
        const [numerator, denominator] = target.split('/').map(Number);
        let current = 0;
        const increment = numerator / (duration / 16);
        const timer = setInterval(() => {
            current += increment;
            if (current >= numerator) {
                element.textContent = target;
                clearInterval(timer);
            } else {
                element.textContent = `${Math.floor(current)}/${denominator}`;
            }
        }, 16);
    } else if (isPercentage) {
        const targetNum = parseInt(target);
        let current = 0;
        const increment = targetNum / (duration / 16);
        const timer = setInterval(() => {
            current += increment;
            if (current >= targetNum) {
                element.textContent = target;
                clearInterval(timer);
            } else {
                element.textContent = `${Math.floor(current)}%`;
            }
        }, 16);
    } else {
        const targetNum = parseInt(target);
        let current = 0;
        const increment = targetNum / (duration / 16);
        const timer = setInterval(() => {
            current += increment;
            if (current >= targetNum) {
                element.textContent = target;
                clearInterval(timer);
            } else {
                element.textContent = Math.floor(current);
            }
        }, 16);
    }
}

// ========== Create Confetti Effect ==========
function createConfetti() {
    const container = document.getElementById('confetti-container');
    if (!container) return;
    
    const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'];
    const confettiCount = 50;
    
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 0.5 + 's';
        confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
        container.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), 5000);
    }
}

// ========== Start Game ==========
document.addEventListener('DOMContentLoaded', () => {
    // Load questions after a short delay to ensure header is ready
    setTimeout(loadQuestions, 200);
});
</script>
</body>

</html>