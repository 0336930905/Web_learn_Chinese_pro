<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Kids Vocabulary Learning</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üéÆ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="../css/games-common.css" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0ea5e9",
                        "secondary": "#ff6bcb",
                        "accent-purple": "#c084fc",
                        "accent-yellow": "#fcd34d",
                        "accent-green": "#4ade80",
                        "background-light": "#fefefe",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px" },
                },
            },
        }

    </script>
    <style>
        body {
            background: #f5f7f8 !important;
        }

        @keyframes blob {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            25% {
                transform: translate(20px, -50px) scale(1.1);
            }

            50% {
                transform: translate(-20px, 20px) scale(0.9);
            }

            75% {
                transform: translate(50px, 50px) scale(1.05);
            }
        }

        .animate-blob {
            animation: blob 7s infinite;
        }

        .animation-delay-2000 {
            animation-delay: 2s;
        }

        .animation-delay-4000 {
            animation-delay: 4s;
        }

        .delay-75 {
            animation-delay: 75ms;
        }

        .delay-150 {
            animation-delay: 150ms;
        }
        #background-color-icon {
            background-color: rgb(255 255 255 / var(--tw-bg-opacity, 1)) !important;
            color: #4e4a4a !important;
            border-color: #cccccc 3px !important ;
        }
        #background-color-icon > #voiceSelect{
             color: #4e4a4a !important;
        }
    </style>
</head>

<body class="font-display text-slate-900 min-h-screen" style="background: #f5f7f8;">
    <!-- Header -->
    <div id="game-header-container"></div>
    <script>
        // Insert common header
        fetch('games-header.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('game-header-container').innerHTML = html;
                // Execute scripts in the loaded HTML
                const scripts = document.getElementById('game-header-container').querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    document.body.appendChild(newScript);
                });
            })
            .catch(err => console.error('Failed to load game header:', err));
    </script>
    <main class="flex-1 flex items-center justify-center relative w-full px-3 py-4 sm:px-4 sm:py-6">
        <button id="prevBtn" onclick="previousCard()"
            class="absolute left-2 sm:left-4 md:left-8 lg:left-24 w-10 h-10 sm:w-12 sm:h-12 bg-white rounded-full shadow-md border-2 border-slate-200 flex items-center justify-center text-slate-600 hover:text-primary hover:border-primary/50 transition-all hover:scale-110 active:scale-95 z-10">
            <span class="material-symbols-outlined text-xl sm:text-2xl">chevron_left</span>
        </button>
        <div class="relative group">
            <div class="absolute -top-5 left-1/2 transform -translate-x-1/2 z-20">
                <div onclick="speakCurrentWord()"
                    class="bg-primary/90 hover:bg-primary text-white px-3 py-1.5 sm:px-4 sm:py-2 md:px-6 md:py-2 rounded-full shadow-lg flex items-center space-x-1.5 sm:space-x-2 text-xs sm:text-sm font-bold uppercase tracking-wider animate-bounce border-2 border-white cursor-pointer hover:scale-105 transition-transform">
                    <span class="material-symbols-outlined text-sm sm:text-base">volume_up</span>
                    <span>Listen carefully</span>
                </div>
            </div>
            <div id="cardContainer"
                class="bg-white rounded-2xl sm:rounded-3xl shadow-xl border-2 border-slate-200 p-4 sm:p-6 md:p-8 w-[90vw] max-w-lg md:max-w-xl lg:max-w-2xl relative flex flex-col items-center justify-center min-h-[350px] sm:min-h-[400px] transition-all duration-300 hover:shadow-2xl">
                <div class="absolute top-3 left-3 sm:top-4 sm:left-4 md:top-6 md:left-6">
                    <span id="progressBadge"
                        class="bg-green-100 text-green-700 shadow-md px-2 py-1 sm:px-3 sm:py-1.5 md:px-4 md:py-1.5 rounded-full text-[10px] sm:text-xs font-bold flex items-center gap-1 border-2 border-green-200">
                        <span class="material-symbols-outlined text-xs sm:text-sm">school</span> <span id="progressText">1 /
                            10</span>
                    </span>
                </div>
                <div class="absolute top-3 right-3 sm:top-4 sm:right-4 md:top-6 md:right-6 flex gap-1.5 sm:gap-2">
                    <button
                        class="w-8 h-8 sm:w-9 sm:h-9 rounded-full bg-yellow-100 shadow-md hover:shadow-lg hover:scale-110 active:scale-95 hover:bg-yellow-200 text-yellow-700 transition-all flex items-center justify-center border border-yellow-200">
                        <span class="material-symbols-outlined text-sm">star</span>
                    </button>
                    <button
                        class="w-8 h-8 sm:w-9 sm:h-9 rounded-full bg-blue-100 shadow-md hover:shadow-lg hover:scale-110 active:scale-95 hover:bg-blue-200 text-blue-700 transition-all flex items-center justify-center border border-blue-200">
                        <span class="material-symbols-outlined text-sm">menu</span>
                    </button>
                </div>
                <div class="flex flex-row items-center justify-center w-full gap-4 sm:gap-6 md:gap-8 mt-2 sm:mt-4">
                    <div id="letterDisplay"
                        class="text-[80px] sm:text-[120px] md:text-[150px] lg:text-[180px] font-black text-primary leading-none select-none drop-shadow-lg">
                        Âùê
                    </div>
                    <div class="bg-blue-50 p-3 sm:p-4 md:p-6 rounded-2xl sm:rounded-3xl border-2 border-blue-200 shadow-lg">
                        <div id="imageContainer"
                            class="w-20 h-20 sm:w-28 sm:h-28 md:w-32 md:h-32 lg:w-40 lg:h-40 flex items-center justify-center text-4xl sm:text-5xl md:text-6xl">
                            ü™ë
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3 sm:mt-4 md:mt-6">
                    <h1 id="traditionalText" class="text-3xl sm:text-4xl md:text-5xl font-extrabold text-primary mb-1 sm:mb-2">Âùê</h1>
                    <p id="pinyinText" class="text-lg sm:text-xl md:text-2xl text-blue-600 font-semibold mb-1 sm:mb-2">zu√≤</p>
                    <p id="meaningText" class="text-base sm:text-lg md:text-xl text-slate-600 font-semibold">Ng·ªìi</p>
                </div>
                <div class="absolute bottom-3 right-3 sm:bottom-4 sm:right-4 md:bottom-6 md:right-6">
                    <span id="difficultyBadge"
                        class="bg-blue-100 text-blue-700 shadow-md px-2 py-1 sm:px-3 sm:py-1.5 md:px-4 md:py-1.5 rounded-full text-[10px] sm:text-xs font-bold flex items-center gap-1 border-2 border-blue-200">
                        <span class="material-symbols-outlined text-xs sm:text-sm">emoji_events</span> <span
                            id="difficultyText">Easy</span>
                    </span>
                </div>
            </div>
            <div class="absolute -bottom-16 sm:-bottom-16 left-1/2 transform -translate-x-1/2 flex flex-col items-center">
                <div class="relative">
                    <div id="recordPingEffect" class="absolute inset-0 bg-pink-400/30 rounded-full animate-ping"
                        style="display: none;"></div>
                    <button onclick="recordUserSpeech()"
                        class="w-16 h-16 sm:w-20 sm:h-20 bg-pink-500 hover:bg-pink-600 rounded-full shadow-lg border-4 border-white hover:scale-110 active:scale-95 flex flex-col items-center justify-center transition-all duration-200 cursor-pointer">
                        <span class="material-symbols-outlined text-white text-2xl sm:text-3xl mb-0.5 sm:mb-1">mic</span>
                        <span class="text-[9px] sm:text-[10px] font-bold text-white uppercase">Record</span>
                    </button>
                </div>
                <div class="flex items-end justify-center h-3 sm:h-4 space-x-1 mt-2">
                    <div class="w-1 bg-gradient-to-t from-pink-400 to-purple-500 rounded-full h-1.5 sm:h-2 animate-pulse"></div>
                    <div
                        class="w-1 bg-gradient-to-t from-purple-400 to-blue-500 rounded-full h-3 sm:h-4 animate-pulse delay-75">
                    </div>
                    <div
                        class="w-1 bg-gradient-to-t from-blue-400 to-cyan-500 rounded-full h-2 sm:h-3 animate-pulse delay-150">
                    </div>
                </div>
            </div>
        </div>
        <button id="nextBtn" onclick="nextCard()"
            class="absolute right-2 sm:right-4 md:right-8 lg:right-24 w-10 h-10 sm:w-12 sm:h-12 bg-white rounded-full shadow-md border-2 border-slate-200 flex items-center justify-center text-slate-600 hover:text-primary hover:border-primary/50 transition-all hover:scale-110 active:scale-95 z-10">
            <span class="material-symbols-outlined text-xl sm:text-2xl">chevron_right</span>
        </button>
    </main>

    <script>
        // ========== Helper: Get categoryId from URL ==========
        function getCategoryIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('categoryId');
        }

        // ========== State ==========
        let cards = [];
        let currentIndex = 0;
        let isPlaying = false; // Track if audio is currently playing
        let isRecording = false; // Track if recording is in progress
        let recognition = null; // Speech recognition instance
        let correctAnswers = 0; // Track correct pronunciation attempts
        let attemptsForCurrentCard = 0; // Track attempts for current word (max 3)
        let totalAttempts = 0; // Track total attempts across all cards
        let gameStartTime = Date.now(); // Track game start time

        // ========== Initialize Speech Recognition ==========
        function initSpeechRecognition() {
            // Check if browser supports Speech Recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                console.warn('Speech Recognition not supported in this browser');
                return null;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-TW'; // Taiwanese Mandarin
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.maxAlternatives = 3;

            recognition.onstart = () => {
                console.log('Speech recognition started');
                isRecording = true;
                updateBottomButton('recording');
            };

            recognition.onresult = (event) => {
                const results = Array.from(event.results[0]);
                const transcripts = results.map(r => r.transcript);
                console.log('Recognized:', transcripts);

                checkPronunciation(transcripts);
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isRecording = false;
                updateBottomButton('default');

                if (event.error === 'no-speech') {
                    updateTopBadge('tryagain');
                    setTimeout(() => updateTopBadge('listen'), 2000);
                }
            };

            recognition.onend = () => {
                console.log('Speech recognition ended');
                isRecording = false;
            };

            return recognition;
        }

        // ========== Load Vocabulary Cards ==========
        async function loadVocabularyCards() {
            const categoryId = getCategoryIdFromUrl();
            if (!categoryId) {
                alert('Kh√¥ng t√¨m th·∫•y categoryId!');
                window.location.href = '../user/games_home.html';
                return;
            }

            try {
                const res = await fetch(`/api/games/vocabulary-cards?categoryId=${categoryId}&count=10`);
                const data = await res.json();

                if (!data.success) {
                    alert('Kh√¥ng th·ªÉ t·∫£i t·ª´ v·ª±ng: ' + (data.error?.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
                    window.location.href = '../user/games_home.html';
                    return;
                }

                cards = data.data;
                currentIndex = 0;
                gameStartTime = Date.now(); // Reset timer

                // Initialize speech recognition
                initSpeechRecognition();

                renderCard();
                updateHeader();
            } catch (err) {
                alert('L·ªói khi g·ªçi API: ' + err.message);
                window.location.href = '../user/games_home.html';
            }
        }

        // ========== Render Current Card ==========
        function renderCard() {
            if (cards.length === 0) return;

            const card = cards[currentIndex];

            // Update letter display
            document.getElementById('letterDisplay').textContent = card.letter;

            // Update main display
            document.getElementById('traditionalText').textContent = card.traditional;
            document.getElementById('pinyinText').textContent = card.pinyin;
            document.getElementById('meaningText').textContent = card.meaning;

            // Update progress
            document.getElementById('progressText').textContent = `${currentIndex + 1} / ${cards.length}`;

            // Update difficulty badge
            const difficultyMap = {
                'beginner': 'D·ªÖ',
                'intermediate': 'Trung b√¨nh',
                'advanced': 'Kh√≥',
                'Easy': 'D·ªÖ',
                'Medium': 'Trung b√¨nh',
                'Hard': 'Kh√≥'
            };
            document.getElementById('difficultyText').textContent = difficultyMap[card.difficulty] || card.difficulty;

            // Update emoji based on word meaning (simple mapping)
            const emojiMap = {
                'Âùê': 'ü™ë', 'Á´ô': 'üßç', 'Ëµ∞': 'üö∂', 'Ë∑ë': 'üèÉ',
                'ÂêÉ': 'üçΩÔ∏è', 'Âñù': 'ü•§', 'Áù°': 'üò¥', 'Á¨ë': 'üòÑ',
                'Âì≠': 'üò¢', 'Áúã': 'üëÄ', 'Âê¨': 'üëÇ', 'ËØ¥': 'üí¨'
            };
            const emoji = emojiMap[card.traditional] || 'üìö';
            document.getElementById('imageContainer').textContent = emoji;

            // Update button states
            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('prevBtn').style.opacity = currentIndex === 0 ? '0.5' : '1';
            
            // Handle Next/Finish button
            const nextBtn = document.getElementById('nextBtn');
            const isLastCard = currentIndex === cards.length - 1;
            
            if (isLastCard) {
                // Change to Finish button on last card
                nextBtn.onclick = showCompletionSummary;
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
                nextBtn.className = 'absolute right-2 sm:right-4 md:right-8 lg:right-24 w-10 h-10 sm:w-12 sm:h-12 bg-green-500 hover:bg-green-600 rounded-full shadow-md border-2 border-green-300 flex items-center justify-center text-white hover:border-green-400 transition-all hover:scale-110 active:scale-95 z-10';
                nextBtn.innerHTML = '<span class="material-symbols-outlined text-xl sm:text-2xl">check_circle</span>';
            } else {
                // Normal Next button
                nextBtn.onclick = nextCard;
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
                nextBtn.className = 'absolute right-2 sm:right-4 md:right-8 lg:right-24 w-10 h-10 sm:w-12 sm:h-12 bg-white rounded-full shadow-md border-2 border-slate-200 flex items-center justify-center text-slate-600 hover:text-primary hover:border-primary/50 transition-all hover:scale-110 active:scale-95 z-10';
                nextBtn.innerHTML = '<span class="material-symbols-outlined text-xl sm:text-2xl">chevron_right</span>';
            }

            // Reset top badge to default state
            updateTopBadge('listen');

            // Reset bottom button to default state
            updateBottomButton('default');

            // Reset attempts for this card
            attemptsForCurrentCard = 0;

            // Auto-play audio when card is rendered
            setTimeout(() => {
                speakCurrentWord();
            }, 300);
        }

        // ========== Next Card ==========
        function nextCard() {
            if (currentIndex >= cards.length - 1) {
                // Already at last card - do nothing (Finish button will show summary)
                return;
            }
            
            currentIndex++;

            // Show "Next card!" badge briefly
            updateTopBadge('next');
            setTimeout(() => {
                renderCard();
                updateHeader();
            }, 300);
        }

        // ========== Previous Card ==========
        function previousCard() {
            if (currentIndex > 0) {
                currentIndex--;

                // Show "Next card!" badge briefly
                updateTopBadge('next');
                setTimeout(() => {
                    renderCard();
                    updateHeader();
                }, 300);
            }
        }

        // ========== Update Top Badge ==========
        function updateTopBadge(state) {
            const badge = document.querySelector('.absolute.-top-5 > div');
            if (!badge) return;

            const iconSpan = badge.querySelector('.material-symbols-outlined');
            const textSpan = badge.querySelector('span:last-child');

            switch (state) {
                case 'listen':
                    badge.className = 'bg-primary/90 hover:bg-primary text-white px-6 py-2 rounded-full shadow-lg flex items-center space-x-2 text-sm font-bold uppercase tracking-wider animate-bounce border-2 border-white cursor-pointer hover:scale-105 transition-transform';
                    iconSpan.textContent = 'volume_up';
                    textSpan.textContent = 'Listen carefully';
                    break;

                case 'playing':
                    badge.className = 'bg-purple-500 text-white px-6 py-2 rounded-full shadow-lg flex items-center space-x-2 text-sm font-bold uppercase tracking-wider animate-pulse border-2 border-white cursor-pointer hover:scale-105 transition-transform';
                    iconSpan.textContent = 'graphic_eq';
                    textSpan.textContent = 'Playing...';
                    break;

                case 'success':
                    badge.className = 'bg-green-500 text-white px-6 py-2 rounded-full shadow-lg flex items-center space-x-2 text-sm font-bold uppercase tracking-wider border-2 border-white cursor-pointer hover:scale-105 transition-transform';
                    iconSpan.textContent = 'check_circle';
                    textSpan.textContent = 'Great job!';
                    break;

                case 'next':
                    badge.className = 'bg-amber-500 text-white px-6 py-2 rounded-full shadow-lg flex items-center space-x-2 text-sm font-bold uppercase tracking-wider animate-bounce border-2 border-white cursor-pointer hover:scale-105 transition-transform';
                    iconSpan.textContent = 'arrow_forward';
                    textSpan.textContent = 'Next card!';
                    break;

                case 'correct':
                    badge.className = 'bg-green-500 text-white px-6 py-2 rounded-full shadow-lg flex items-center space-x-2 text-sm font-bold uppercase tracking-wider animate-bounce border-2 border-white cursor-pointer hover:scale-105 transition-transform';
                    iconSpan.textContent = 'check_circle';
                    textSpan.textContent = 'Perfect! Â§™Ê£í‰∫Ü!';
                    break;

                case 'wrong':
                    badge.className = 'bg-red-500 text-white px-6 py-2 rounded-full shadow-lg flex items-center space-x-2 text-sm font-bold uppercase tracking-wider animate-pulse border-2 border-white cursor-pointer hover:scale-105 transition-transform';
                    iconSpan.textContent = 'cancel';
                    textSpan.textContent = 'Try again!';
                    break;

                case 'tryagain':
                    badge.className = 'bg-yellow-500 text-white px-6 py-2 rounded-full shadow-lg flex items-center space-x-2 text-sm font-bold uppercase tracking-wider animate-pulse border-2 border-white cursor-pointer hover:scale-105 transition-transform';
                    iconSpan.textContent = 'mic_off';
                    textSpan.textContent = 'No sound detected';
                    break;
            }
        }

        // ========== Update Bottom Button (Record Button) ==========
        function updateBottomButton(state) {
            const button = document.querySelector('button[onclick="recordUserSpeech()"]');
            const pingEffect = document.getElementById('recordPingEffect');
            if (!button) return;

            const iconSpan = button.querySelector('.material-symbols-outlined');
            const textSpan = button.querySelector('span:last-child');

            switch (state) {
                case 'default':
                    button.className = 'w-16 h-16 sm:w-20 sm:h-20 bg-pink-500 hover:bg-pink-600 rounded-full shadow-lg border-4 border-white hover:scale-110 active:scale-95 flex flex-col items-center justify-center transition-all duration-200 cursor-pointer';
                    button.disabled = false;
                    iconSpan.textContent = 'mic';
                    textSpan.textContent = 'Record';
                    if (pingEffect) pingEffect.style.display = 'none';
                    break;

                case 'recording':
                    button.className = 'w-16 h-16 sm:w-20 sm:h-20 bg-red-500 rounded-full shadow-lg border-4 border-white animate-pulse flex flex-col items-center justify-center transition-all duration-200 cursor-pointer';
                    iconSpan.textContent = 'mic';
                    textSpan.textContent = 'Listening';
                    if (pingEffect) pingEffect.style.display = 'block';
                    break;

                case 'analyzing':
                    button.className = 'w-16 h-16 sm:w-20 sm:h-20 bg-yellow-500 rounded-full shadow-lg border-4 border-white animate-pulse flex flex-col items-center justify-center transition-all duration-200';
                    iconSpan.textContent = 'settings_voice';
                    textSpan.textContent = 'Checking';
                    if (pingEffect) pingEffect.style.display = 'none';
                    break;

                case 'correct':
                    button.className = 'w-16 h-16 sm:w-20 sm:h-20 bg-green-500 rounded-full shadow-lg border-4 border-white animate-bounce flex flex-col items-center justify-center transition-all duration-200';
                    iconSpan.textContent = 'check_circle';
                    textSpan.textContent = 'Correct!';
                    if (pingEffect) pingEffect.style.display = 'none';
                    break;

                case 'wrong':
                    button.className = 'w-16 h-16 sm:w-20 sm:h-20 bg-red-400 rounded-full shadow-lg border-4 border-white animate-pulse flex flex-col items-center justify-center transition-all duration-200 opacity-50 cursor-not-allowed';
                    button.disabled = true; // Disable button when wrong
                    iconSpan.textContent = 'cancel';
                    textSpan.textContent = 'Try again';
                    if (pingEffect) pingEffect.style.display = 'none';
                    break;

                case 'disabled':
                    button.className = 'w-16 h-16 sm:w-20 sm:h-20 bg-slate-400 rounded-full shadow-lg border-4 border-white flex flex-col items-center justify-center transition-all duration-200 opacity-50 cursor-not-allowed';
                    button.disabled = true; // Disable during playback
                    iconSpan.textContent = 'mic_off';
                    textSpan.textContent = 'Wait...';
                    if (pingEffect) pingEffect.style.display = 'none';
                    break;
            }
        }

        // ========== Speak Current Word (Playback Only) ==========
        function speakCurrentWord() {
            if (cards.length === 0) return;
            if (isPlaying) return; // Prevent multiple simultaneous plays

            const card = cards[currentIndex];
            isPlaying = true;

            // Update badge to "Playing..." state
            updateTopBadge('playing');

            // Disable Record button during playback
            updateBottomButton('disabled');

            // Speak the word
            if (window.speakText) {
                window.speakText(card.traditional, 0.8);

                // Estimate speech duration (rough approximation)
                const estimatedDuration = card.traditional.length * 500 + 1000;

                // Reset after speaking
                setTimeout(() => {
                    isPlaying = false;
                    updateTopBadge('success');

                    // Return to default state after a moment
                    setTimeout(() => {
                        updateTopBadge('listen');
                        updateBottomButton('default'); // Re-enable Record button
                    }, 1500);
                }, estimatedDuration);
            } else {
                // Fallback if speakText not available
                isPlaying = false;
                updateTopBadge('listen');
                updateBottomButton('default');
            }
        }

        // ========== Record User Speech (Speech Recognition) ==========
        function recordUserSpeech() {
            if (cards.length === 0) return;
            if (isRecording) return; // Already recording
            if (isPlaying) {
                // Prevent recording while audio is playing
                alert('‚è∏Ô∏è Vui l√≤ng ƒë·ª£i √¢m thanh ph√°t xong!');
                return;
            }
            if (!recognition) {
                alert('Êä±Ê≠âÔºåÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊåÅË™ûÈü≥Ë≠òÂà•ÂäüËÉΩ„ÄÇË´ã‰ΩøÁî® Chrome Êàñ Edge ÁÄèË¶ΩÂô®„ÄÇ');
                return;
            }

            try {
                recognition.start();
                console.log('Starting speech recognition...');
            } catch (error) {
                console.error('Failed to start recognition:', error);
                updateBottomButton('default');
            }
        }

        // ========== Check Pronunciation ==========
        function checkPronunciation(transcripts) {
            if (cards.length === 0) return;

            const card = cards[currentIndex];
            const correctWord = card.traditional;

            // Update button to analyzing state
            updateBottomButton('analyzing');

            // Check if any of the recognized alternatives match
            const isCorrect = transcripts.some(transcript => {
                const cleanTranscript = transcript.trim();
                // Exact match or contains the correct character
                return cleanTranscript === correctWord || cleanTranscript.includes(correctWord);
            });

            setTimeout(() => {
                totalAttempts++;

                if (isCorrect) {
                    // Correct pronunciation
                    correctAnswers++;
                    updateTopBadge('correct');
                    updateBottomButton('correct');

                    // Update score with animation
                    if (window.animateScoreUpdate) {
                        window.animateScoreUpdate(correctAnswers * 10);
                    }

                    // Auto-advance to next card after celebration
                    setTimeout(() => {
                        if (currentIndex < cards.length - 1) {
                            nextCard();
                        } else {
                            // Last card completed - show success message but let user click Finish
                            updateTopBadge('success');
                            const textSpan = document.querySelector('.absolute.-top-5 > div span:last-child');
                            if (textSpan) textSpan.textContent = 'Click ‚úì to finish!';
                        }
                    }, 2000);
                } else {
                    // Incorrect pronunciation
                    attemptsForCurrentCard++;
                    updateTopBadge('wrong');
                    updateBottomButton('wrong');

                    if (attemptsForCurrentCard >= 3) {
                        // Failed 3 times - skip to next card or show message for last card
                        setTimeout(() => {
                            updateTopBadge('next');
                            const textSpan = document.querySelector('.absolute.-top-5 > div span:last-child');
                            
                            if (currentIndex === cards.length - 1) {
                                // Last card - show finish message
                                if (textSpan) textSpan.textContent = 'Click ‚úì to finish!';
                            } else {
                                // Not last card - move on
                                if (textSpan) textSpan.textContent = 'Moving on...';
                                setTimeout(() => {
                                    nextCard();
                                }, 1500);
                            }
                        }, 2000);
                    } else {
                        // Play correct pronunciation
                        setTimeout(() => {
                            speakCurrentWord();
                        }, 3500);

                        // Reset to default after audio finishes (but show finish message if last card)
                        setTimeout(() => {
                            if (currentIndex === cards.length - 1) {
                                updateTopBadge('next');
                                const textSpan = document.querySelector('.absolute.-top-5 > div span:last-child');
                                if (textSpan) textSpan.textContent = 'Click ‚úì to finish!';
                            } else {
                                updateTopBadge('listen');
                            }
                            updateBottomButton('default');
                        }, 6500);
                    }
                }

                updateHeader();
            }, 800);
        }

        // ========== Show Completion Summary ==========
        function showCompletionSummary() {
            const percentage = Math.round((correctAnswers / cards.length) * 100);
            const avgAttempts = (totalAttempts / cards.length).toFixed(1);
            const totalPoints = correctAnswers * 10;
            const wrongAnswers = cards.length - correctAnswers;
            const duration = Math.floor((Date.now() - gameStartTime) / 1000);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;

            // Determine performance level
            let performanceEmoji = 'üéâ';
            let performanceText = 'Xu·∫•t s·∫Øc!';
            let performanceColor = 'from-green-500 to-emerald-500';

            if (percentage >= 90) {
                performanceEmoji = 'üèÜ';
                performanceText = 'Ho√†n h·∫£o!';
                performanceColor = 'from-yellow-400 to-amber-500';
            } else if (percentage >= 70) {
                performanceEmoji = 'üéâ';
                performanceText = 'R·∫•t t·ªët!';
                performanceColor = 'from-green-500 to-emerald-500';
            } else if (percentage >= 50) {
                performanceEmoji = 'üëç';
                performanceText = 'T·ªët!';
                performanceColor = 'from-blue-500 to-cyan-500';
            } else {
                performanceEmoji = 'üí™';
                performanceText = 'C·ªë g·∫Øng l√™n!';
                performanceColor = 'from-orange-500 to-red-500';
            }

            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 px-4';
            overlay.innerHTML = `
                <div id="confetti-container" class="fixed inset-0 pointer-events-none z-50"></div>
                <div class="bg-gradient-to-br from-white via-blue-50 to-purple-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 rounded-2xl md:rounded-3xl shadow-2xl p-5 sm:p-8 max-w-lg w-full border-4 border-gradient-to-r from-cyan-200 via-blue-200 to-purple-200 dark:border-gray-700 transform result-card">
                    <div class="text-center">
                        <!-- Emoji with animation -->
                        <div class="text-6xl sm:text-8xl mb-4 emoji-animation inline-block">${performanceEmoji}</div>
                        
                        <!-- Title -->
                        <h2 class="text-2xl sm:text-4xl font-black bg-gradient-to-r ${performanceColor} bg-clip-text text-transparent mb-2">${performanceText}</h2>
                        <p class="text-base sm:text-xl text-gray-600 dark:text-gray-300 mb-4 sm:mb-6">ÊÅ≠ÂñúÂÆåÊàêÔºÅ</p>
                        
                        <!-- Time Badge -->
                        <div class="inline-flex items-center gap-2 bg-gradient-to-r from-indigo-100 to-purple-100 dark:from-indigo-900/30 dark:to-purple-900/30 px-4 py-2 rounded-full mb-4">
                            <span class="material-symbols-outlined text-indigo-600 dark:text-indigo-400 text-lg">schedule</span>
                            <span class="text-sm font-bold text-indigo-700 dark:text-indigo-300">${minutes}:${seconds.toString().padStart(2, '0')}</span>
                        </div>
                        
                        <!-- Stats Grid with Animations -->
                        <div class="bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm rounded-2xl p-4 sm:p-6 shadow-lg mb-4 sm:mb-6">
                            <div class="grid grid-cols-2 gap-3 sm:gap-4">
                                <div class="stat-card text-center p-3 sm:p-4 bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-xl border-2 border-green-200 dark:border-green-700 hover:scale-105 transition-transform duration-200">
                                    <div class="text-2xl sm:text-3xl font-black text-green-600 dark:text-green-400" data-value="${correctAnswers}/${cards.length}">0/${cards.length}</div>
                                    <div class="text-xs sm:text-sm text-green-700 dark:text-green-300 font-semibold mt-1">ƒê√∫ng</div>
                                </div>
                                <div class="stat-card text-center p-3 sm:p-4 bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 rounded-xl border-2 border-blue-200 dark:border-blue-700 hover:scale-105 transition-transform duration-200">
                                    <div class="text-2xl sm:text-3xl font-black text-blue-600 dark:text-blue-400" data-value="${percentage}%">0%</div>
                                    <div class="text-xs sm:text-sm text-blue-700 dark:text-blue-300 font-semibold mt-1">Ch√≠nh x√°c</div>
                                </div>
                                <div class="stat-card text-center p-3 sm:p-4 bg-gradient-to-br from-purple-50 to-violet-50 dark:from-purple-900/20 dark:to-violet-900/20 rounded-xl border-2 border-purple-200 dark:border-purple-700 hover:scale-105 transition-transform duration-200">
                                    <div class="text-2xl sm:text-3xl font-black text-purple-600 dark:text-purple-400" data-value="${totalPoints}">0</div>
                                    <div class="text-xs sm:text-sm text-purple-700 dark:text-purple-300 font-semibold mt-1">ƒêi·ªÉm</div>
                                </div>
                                <div class="stat-card text-center p-3 sm:p-4 bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-xl border-2 border-amber-200 dark:border-amber-700 hover:scale-105 transition-transform duration-200">
                                    <div class="text-2xl sm:text-3xl font-black text-amber-600 dark:text-amber-400" data-value="${avgAttempts}">0</div>
                                    <div class="text-xs sm:text-sm text-amber-700 dark:text-amber-300 font-semibold mt-1">TB Th·ª≠/T·ª´</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button onclick="location.reload()" 
                                class="group flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 sm:py-4 rounded-xl sm:rounded-2xl font-bold shadow-lg hover:shadow-xl active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined group-hover:rotate-180 transition-transform duration-500">refresh</span>
                                <span>Ch∆°i l·∫°i</span>
                            </button>
                            <button onclick="window.location.href='../user/games_home.html'" 
                                class="group flex-1 bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white px-6 py-3 sm:py-4 rounded-xl sm:rounded-2xl font-bold shadow-lg hover:shadow-xl active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined group-hover:scale-110 transition-transform duration-200">home</span>
                                <span>V·ªÅ trang ch·ªß</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add enhanced animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes scaleIn {
                    from { transform: scale(0.8) translateY(20px); opacity: 0; }
                    to { transform: scale(1) translateY(0); opacity: 1; }
                }
                @keyframes statPop {
                    0% { transform: scale(0.5); opacity: 0; }
                    50% { transform: scale(1.1); }
                    100% { transform: scale(1); opacity: 1; }
                }
                @keyframes emojiFloat {
                    0%, 100% { transform: translateY(0) rotate(0deg); }
                    25% { transform: translateY(-10px) rotate(-5deg); }
                    75% { transform: translateY(-5px) rotate(5deg); }
                }
                @keyframes confettifall {
                    to { transform: translateY(100vh) rotate(360deg); }
                }
                .result-card { animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
                .stat-card { animation: statPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
                .stat-card:nth-child(1) { animation-delay: 0.1s; opacity: 0; animation-fill-mode: forwards; }
                .stat-card:nth-child(2) { animation-delay: 0.2s; opacity: 0; animation-fill-mode: forwards; }
                .stat-card:nth-child(3) { animation-delay: 0.3s; opacity: 0; animation-fill-mode: forwards; }
                .stat-card:nth-child(4) { animation-delay: 0.4s; opacity: 0; animation-fill-mode: forwards; }
                .emoji-animation { animation: emojiFloat 2s ease-in-out infinite; }
                .confetti { position: absolute; width: 10px; height: 10px; animation: confettifall 3s linear forwards; }
            `;
            document.head.appendChild(style);

            document.body.appendChild(overlay);
            
            // Animate stats with count-up effect
            setTimeout(() => {
                const statCards = overlay.querySelectorAll('.stat-card > div[data-value]');
                statCards.forEach((stat, index) => {
                    const targetValue = stat.getAttribute('data-value');
                    animateValue(stat, targetValue, 1000 + (index * 100));
                });
            }, 500);
            
            // Create confetti for high scores
            if (percentage >= 70) {
                setTimeout(() => createConfetti(), 800);
            }
        }
        
        // ========== Animate Value Count-up ==========
        function animateValue(element, target, duration) {
            const isPercentage = target.includes('%');
            const isFraction = target.includes('/');
            const isDecimal = target.includes('.');
            
            if (isFraction) {
                const [numerator, denominator] = target.split('/').map(Number);
                let current = 0;
                const increment = numerator / (duration / 16);
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= numerator) {
                        element.textContent = target;
                        clearInterval(timer);
                    } else {
                        element.textContent = `${Math.floor(current)}/${denominator}`;
                    }
                }, 16);
            } else if (isPercentage) {
                const targetNum = parseInt(target);
                let current = 0;
                const increment = targetNum / (duration / 16);
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= targetNum) {
                        element.textContent = target;
                        clearInterval(timer);
                    } else {
                        element.textContent = `${Math.floor(current)}%`;
                    }
                }, 16);
            } else if (isDecimal) {
                const targetNum = parseFloat(target);
                let current = 0;
                const increment = targetNum / (duration / 16);
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= targetNum) {
                        element.textContent = target;
                        clearInterval(timer);
                    } else {
                        element.textContent = current.toFixed(1);
                    }
                }, 16);
            } else {
                const targetNum = parseInt(target);
                let current = 0;
                const increment = targetNum / (duration / 16);
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= targetNum) {
                        element.textContent = target;
                        clearInterval(timer);
                    } else {
                        element.textContent = Math.floor(current);
                    }
                }, 16);
            }
        }
        
        // ========== Create Confetti Effect ==========
        function createConfetti() {
            const container = document.getElementById('confetti-container');
            if (!container) return;
            
            const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                container.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 5000);
            }
        }

        // ========== Update Header ==========
        function updateHeader() {
            if (window.updateGameHeaderProgress) {
                window.updateGameHeaderProgress({
                    current: currentIndex + 1,
                    total: cards.length,
                    score: correctAnswers * 10,
                    label: 'Card',
                    animateScore: false
                });
            }
        }

        // ========== Start Game ==========
        document.addEventListener('DOMContentLoaded', loadVocabularyCards);

        // Simple dark mode toggle for demonstration purposes
        // Ideally this would be connected to a toggle button, but applying system preference automatically
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
    </script>

</body>

</html>